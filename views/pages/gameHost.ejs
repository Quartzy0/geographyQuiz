<!doctype html>
<html lang="en">
<head>
    <title>Geography quiz</title>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        let xhttp;
        let socket;
        let pin;
        let slideLength;

        function load() {
            if (window.XMLHttpRequest) {
                // code for modern browsers
                xhttp = new XMLHttpRequest();
            } else {
                // code for old IE browsers
                xhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
        }

        function onLoad() {
            load();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    socket = io();
                    socket.emit('myIdentificationIsHere', {pin: this.responseText, iAmMaster: true});
                    pin = this.responseText;
                    socket.on('statusUpdate', function (data) {
                        if (data.value==="urOk."){
                            document.getElementById("Pin").innerText = 'Pin: ' + pin;
                            slideLength = data.slideLength;
                        }else {
                            document.getElementById("Pin").innerText = "An unexpected error occurred!";
                        }
                    });
                    socket.on('guyJoined', function (data) {
                        let newListElement = document.createElement("li");
                        let newListElementText = document.createTextNode(data.name);
                        newListElement.setAttribute('id', data.name);

                        newListElement.appendChild(newListElementText);
                        document.getElementById("list").appendChild(newListElement);

                        const length = document.getElementById("list").getElementsByTagName("li").length;
                        document.getElementById("playerCount").innerText = length + (length===1 ? " player" : " players");
                    });
                    socket.on('nerdLeft_lolNoob', function (data) {
                        var ul = document.getElementById("list");
                        var candidate = document.getElementById(data.lozerWhoLeft);
                        ul.removeChild(candidate);
                        const length = document.getElementById("list").getElementsByTagName("li").length;
                        document.getElementById("playerCount").innerText = length + (length===1 ? " player" : " players");
                    });
                    socket.on('hereIsBigBoyUpdate', function (data) {
                        if (data.amIGoodBoy){
                            document.getElementById(data.name).innerHTML = data.name;
                        }else {
                            document.getElementById(data.name).innerHTML = data.name + " - <strong style='color: red'>Doing something else</strong>";
                        }
                    });
                    socket.on('slideData', function (data) {
                        document.getElementById("slide").innerHTML = data.slide;
                    });
                }
            };
            xhttp.open("POST", "/createSession", true);
            xhttp.setRequestHeader('Content-Type', 'application/json');
            xhttp.send();
        }

        function startGame() {
            document.getElementById("mainScreen").style.display = "none";
            document.getElementById("slides").style.display = "block";

            nextSlide();
            socket.emit('startGamePls', {pin: pin});
        }

        var slideIndex = -1;

        function nextSlide() {
            if (slideIndex+1<slideLength) {
                slideIndex++;
                socket.emit('slideUpdate', {slideIndex: slideIndex, pin: pin});
            }
        }

        function prevSlide() {
            if (slideIndex-1>-1) {
                slideIndex--;
                socket.emit('slideUpdate', {slideIndex: slideIndex, pin: pin});
            }
        }
    </script>

    <style>
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        li {
            float: left;
            padding: 16px;
            font-size: 40px;
            color: #FFFFFF;
        }

        li:hover {
            color: #CCCCCC;
        }
    </style>

    <style>
        /* Style the header with a grey background and some padding */
        .header {
            overflow: hidden;
            background-color: #f1f1f1;
            padding: 20px 10px;
        }

        /* Style the header links */
        .header img {
            float: left;
            color: black;
            text-align: center;
            padding: 12px;
            text-decoration: none;
            font-size: 18px;
            line-height: 25px;
            border-radius: 4px;
        }

        /* Change the background color on mouse-over */
        .header img:hover {
            background-color: #ddd;
            color: black;
        }

        /* Style the active/current link*/
        .header img.active {
            color: white;
        }

        /* Float the link section to the right */
        .header-right {
            float: right;
        }

        /* Add media queries for responsiveness - when the screen is 500px wide or less, stack the links on top of each other */
        @media screen and (max-width: 500px) {
            .header img {
                float: none;
                display: block;
                text-align: left;
            }
            .header-right {
                float: none;
            }
        }
    </style>

    <% include ../partials/head.ejs %>
</head>

<body style="background-color: #56baed;" onload="onLoad()">

<!--    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);-->
    <div id="mainScreen">

        <div class="card" style="position: absolute; left: 50%; top: 10%; transform: translate(-50%, -50%);">
            <div class="card-body">
                <h1 id="Pin" style="font-size: 60px">Connecting...</h1>
            </div>
        </div>

        <button class="btn btn-primary" style="position: absolute; left: 90%; top: 30%; transform: translate(-50%, -50%); width: 100px; height: 50px; font-size: 20px" onclick="startGame()">Start</button>
        <h1 style="position: absolute; left: 10%; top: 30%; transform: translate(-50%, -50%); font-size: 40px; color: white" id="playerCount">0 players</h1>

        <div>
            <ul style="position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%);" id="list">

            </ul>
        </div>

    </div>

    <div id="slides" style="display: none;">
        <div id="headThingy">
            <div class="header" style="height: 70px">
                <div class="header-right">
                    <img class="active" id="prevBtn" src="/public/leftArrow.png" alt="Previous slide" style="width: 64px; height: 64px;" onclick="prevSlide()">
                    <img class="active" id="nextBtn" src="/public/rightArrow.png" alt="Next slide" style="width: 64px; height: 64px;" onclick="nextSlide()">
                </div>
            </div>
        </div>

        <div id="slide">

        </div>
    </div>

<% include ../partials/bootsrapScripts.ejs %>
</body>
</html>